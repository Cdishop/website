---
title: "Spline Modeling"
output:
  html_document:
    df_print: paged
date: '2018-05-05'
---



<p>A few spline models (also known as piecewise models). As in previous posts, ‘affect’ is the name given to values of <span class="math inline">\(y\)</span> throughout.</p>
<div id="growth-and-even-more-growth" class="section level1">
<h1>1) Growth and Even More Growth</h1>
<p>A model that captures a process that increases initially and then increases at an even greater rate once it reaches time point 5. The data generating process:</p>
<p><span class="math display">\[\begin{equation}
y_{it} = 
  \begin{cases}
  4 + 0.3t + error_{t}, &amp; \text{if time &lt; 5}\\
  8 + 0.9t + error_{t}, &amp; \text{otherwise}
  \end{cases}
\end{equation}\]</span></p>
<p>The data generating code and plot</p>
<pre class="r"><code>library(tidyverse)
library(lavaan)
library(ggplot2)
library(MASS)
library(ggthemes)

N &lt;- 400
time &lt;- 10

intercept_1 &lt;- 4
intercept_2 &lt;- 8

growth1 &lt;- 0.3
growth2 &lt;- 0.9


df_matrix &lt;- matrix(, ncol = 3, nrow = N*time)


count &lt;- 0

for(i in 1:N){
  
  unob_het_y &lt;- rnorm(1,0,1)
  
  
  for(j in 1:time){
    
    count &lt;- count + 1
    
    if(j &lt; 5){
    df_matrix[count, 1] &lt;- i
    df_matrix[count, 2] &lt;- j
    df_matrix[count, 3] &lt;- intercept_1 + growth1*j + unob_het_y + rnorm(1,0,1)
    
    }else{
      
      df_matrix[count, 1] &lt;- i
      df_matrix[count, 2] &lt;- j
      df_matrix[count, 3] &lt;- intercept_2 + growth2*j + unob_het_y + rnorm(1,0,1)
      
      
    }
  }
  
}

df &lt;- data.frame(df_matrix)

names(df) &lt;- c(&#39;id&#39;, &#39;time&#39;, &#39;affect&#39;)

df1 &lt;- df %&gt;%
  filter(time &lt; 5)

df2 &lt;- df %&gt;%
  filter(time &gt;= 5)

df_sum1 &lt;- df1 %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

df_sum2 &lt;- df2 %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

ggplot() + 
  geom_point(data = df1, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df1, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_point(data = df2, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df2, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df_sum1, aes(x = time, y = affect)) + 
  geom_line(data = df_sum2, aes(x = time, y = affect)) + 
  theme_wsj()</code></pre>
<p><img src="/Computational_Notes/spline_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>Estimating the parameters using SEM:</p>
<pre class="r"><code>library(lavaan)

df_wide &lt;- reshape(df, idvar = &#39;id&#39;, timevar = &#39;time&#39;, direction = &#39;wide&#39;)


spline_string &lt;- &#39;

# latent intercept for first half

level1_affect =~ 1*affect.1 + 1*affect.2 + 1*affect.3 + 1*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10

# latent intercept for second half

level2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 1*affect.5 + 1*affect.6 + 1*affect.7 + 1*affect.8 + 1*affect.9 + 1*affect.10

# latent slope for first half basis coefficients

slope1_affect =~ 1*affect.1 + 2*affect.2 + 3*affect.3 + 4*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10

# latent slope for second half basis coefficients

slope2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 5*affect.5 + 6*affect.6 + 7*affect.7 + 8*affect.8 + 9*affect.9 + 10*affect.10

# means and variance of latent factors

level1_affect ~~ level1_affect
level2_affect ~~ level2_affect
slope1_affect ~~ slope1_affect
slope2_affect ~~ slope2_affect

# covariance between latent factors

level1_affect ~~ level2_affect
level1_affect ~~ slope1_affect
level1_affect ~~ slope2_affect

level2_affect ~~ slope1_affect
level2_affect ~~ slope2_affect

slope1_affect ~~ slope2_affect

# constrain means of indicators to zero across time

affect.1 ~ 0
affect.2 ~ 0
affect.3 ~ 0
affect.4 ~ 0
affect.5 ~ 0
affect.6 ~ 0
affect.7 ~ 0
affect.8 ~ 0
affect.9 ~ 0
affect.10 ~ 0

# constrain residual variance to equality across time

affect.1 ~~ res_var*affect.1
affect.2 ~~ res_var*affect.2
affect.3 ~~ res_var*affect.3
affect.4 ~~ res_var*affect.4
affect.5 ~~ res_var*affect.5
affect.6 ~~ res_var*affect.6
affect.7 ~~ res_var*affect.7
affect.8 ~~ res_var*affect.8
affect.9 ~~ res_var*affect.9
affect.10 ~~ res_var*affect.10

&#39;

spline_model &lt;- growth(spline_string, data = df_wide)
summary(spline_model, fit.measures = T)</code></pre>
<pre><code>## lavaan 0.6-6 ended normally after 86 iterations
## 
##   Estimator                                         ML
##   Optimization method                           NLMINB
##   Number of free parameters                         24
##   Number of equality constraints                     9
##                                                       
##   Number of observations                           400
##                                                       
## Model Test User Model:
##                                                       
##   Test statistic                                50.748
##   Degrees of freedom                                50
##   P-value (Chi-square)                           0.444
## 
## Model Test Baseline Model:
## 
##   Test statistic                              1927.541
##   Degrees of freedom                                45
##   P-value                                        0.000
## 
## User Model versus Baseline Model:
## 
##   Comparative Fit Index (CFI)                    1.000
##   Tucker-Lewis Index (TLI)                       1.000
## 
## Loglikelihood and Information Criteria:
## 
##   Loglikelihood user model (H0)              -6057.519
##   Loglikelihood unrestricted model (H1)      -6032.145
##                                                       
##   Akaike (AIC)                               12145.039
##   Bayesian (BIC)                             12204.911
##   Sample-size adjusted Bayesian (BIC)        12157.315
## 
## Root Mean Square Error of Approximation:
## 
##   RMSEA                                          0.006
##   90 Percent confidence interval - lower         0.000
##   90 Percent confidence interval - upper         0.033
##   P-value RMSEA &lt;= 0.05                          1.000
## 
## Standardized Root Mean Square Residual:
## 
##   SRMR                                           0.045
## 
## Parameter Estimates:
## 
##   Standard errors                             Standard
##   Information                                 Expected
##   Information saturated (h1) model          Structured
## 
## Latent Variables:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   level1_affect =~                                    
##     affect.1          1.000                           
##     affect.2          1.000                           
##     affect.3          1.000                           
##     affect.4          1.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         0.000                           
##   level2_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          1.000                           
##     affect.6          1.000                           
##     affect.7          1.000                           
##     affect.8          1.000                           
##     affect.9          1.000                           
##     affect.10         1.000                           
##   slope1_affect =~                                    
##     affect.1          1.000                           
##     affect.2          2.000                           
##     affect.3          3.000                           
##     affect.4          4.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         0.000                           
##   slope2_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          5.000                           
##     affect.6          6.000                           
##     affect.7          7.000                           
##     affect.8          8.000                           
##     affect.9          9.000                           
##     affect.10        10.000                           
## 
## Covariances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   level1_affect ~~                                    
##     level2_affect     1.252    0.166    7.521    0.000
##     slope1_affect     0.029    0.043    0.688    0.491
##     slope2_affect    -0.034    0.017   -2.005    0.045
##   level2_affect ~~                                    
##     slope1_affect    -0.074    0.043   -1.731    0.083
##     slope2_affect     0.053    0.031    1.699    0.089
##   slope1_affect ~~                                    
##     slope2_affect     0.009    0.005    2.014    0.044
## 
## Intercepts:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##    .affect.1          0.000                           
##    .affect.2          0.000                           
##    .affect.3          0.000                           
##    .affect.4          0.000                           
##    .affect.5          0.000                           
##    .affect.6          0.000                           
##    .affect.7          0.000                           
##    .affect.8          0.000                           
##    .affect.9          0.000                           
##    .affect.10         0.000                           
##     level1_affect     3.920    0.077   50.867    0.000
##     level2_affect     7.849    0.100   78.463    0.000
##     slope1_affect     0.315    0.021   14.801    0.000
##     slope2_affect     0.913    0.011   83.276    0.000
## 
## Variances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##     lvl1_ff           0.899    0.173    5.184    0.000
##     lvl2_ff           0.673    0.299    2.251    0.024
##     slp1_ff          -0.016    0.014   -1.169    0.243
##     slp2_ff          -0.008    0.004   -2.191    0.028
##    .affct.1 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.2 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.3 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.4 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.5 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.6 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.7 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.8 (rs_v)    0.985    0.028   34.641    0.000
##    .affct.9 (rs_v)    0.985    0.028   34.641    0.000
##    .affc.10 (rs_v)    0.985    0.028   34.641    0.000</code></pre>
<p>The structure of the basis coefficients is the important piece that allows us to capture the change in slope:</p>
<pre class="r"><code>&#39;
# latent slope for first half basis coefficients

slope1_affect =~ 1*affect.1 + 2*affect.2 + 3*affect.3 + 4*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10

# latent slope for second half basis coefficients

slope2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 5*affect.5 + 6*affect.6 + 7*affect.7 + 8*affect.8 + 9*affect.9 + 10*affect.10

&#39;</code></pre>
</div>
<div id="growth-and-negative-growth" class="section level1">
<h1>2) Growth and Negative Growth</h1>
<p>A model that captures a process that goes up and then goes down. The data generating process:</p>
<p><span class="math display">\[\begin{equation}
y_{it} = 
  \begin{cases}
  4 + 0.5t + error_{t}, &amp; \text{if time &lt; 5}\\
  4 - 0.5t + error_{t}, &amp; \text{otherwise}
  \end{cases}
\end{equation}\]</span></p>
<p>The data generating code and plot</p>
<pre class="r"><code>library(tidyverse)
library(lavaan)
library(ggplot2)
library(MASS)

N &lt;- 400
time &lt;- 10

intercept_1 &lt;- 4
intercept_2 &lt;- 4

growth1 &lt;- 0.8
growth2 &lt;- -0.8

df_matrix_b &lt;- matrix(, ncol = 3, nrow = N*time)


count &lt;- 0

for(i in 1:N){
  
  unob_het_y &lt;- rnorm(1,0,1)
  
  
  for(j in 1:time){
    
    count &lt;- count + 1
    
    if(j &lt; 5){
      df_matrix_b[count, 1] &lt;- i
      df_matrix_b[count, 2] &lt;- j
      df_matrix_b[count, 3] &lt;- intercept_1 + growth1*j + unob_het_y + rnorm(1,0,1)
      
    }else{
      
      df_matrix_b[count, 1] &lt;- i
      df_matrix_b[count, 2] &lt;- j
      df_matrix_b[count, 3] &lt;- intercept_2 + growth2*j + unob_het_y + rnorm(1,0,1)
      
      
    }
  }
  
}

df_b &lt;- data.frame(df_matrix_b)

names(df_b) &lt;- c(&#39;id&#39;, &#39;time&#39;, &#39;affect&#39;)

df1_b &lt;- df_b %&gt;%
  filter(time &lt; 5)

df2_b &lt;- df_b %&gt;%
  filter(time &gt;= 5)

df_sum1_b &lt;- df1_b %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

df_sum2_b &lt;- df2_b %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

ggplot() + 
  geom_point(data = df1_b, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df1_b, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_point(data = df2_b, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df2_b, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df_sum1_b, aes(x = time, y = affect)) + 
  geom_line(data = df_sum2_b, aes(x = time, y = affect)) + 
  theme_wsj()</code></pre>
<p><img src="/Computational_Notes/spline_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Estimating the parameters using SEM:</p>
<pre class="r"><code>library(lavaan)


df_wide_b &lt;- reshape(df_b, idvar = &#39;id&#39;, timevar = &#39;time&#39;, direction = &#39;wide&#39;)


spline_string_b &lt;- &#39;

# latent intercept for first half

level1_affect =~ 1*affect.1 + 1*affect.2 + 1*affect.3 + 1*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10

# latent intercept for second half

level2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 1*affect.5 + 1*affect.6 + 1*affect.7 + 1*affect.8 + 1*affect.9 + 1*affect.10

# latent slope for first half basis coefficients

slope1_affect =~ 1*affect.1 + 2*affect.2 + 3*affect.3 + 4*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10

# latent slope for second half basis coefficients

slope2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 5*affect.5 + 6*affect.6 + 7*affect.7 + 8*affect.8 + 9*affect.9 + 10*affect.10

# means and variance of latent factors

level1_affect ~~ level1_affect
level2_affect ~~ level2_affect
slope1_affect ~~ slope1_affect
slope2_affect ~~ slope2_affect

# covariance between latent factors

level1_affect ~~ level2_affect
level1_affect ~~ slope1_affect
level1_affect ~~ slope2_affect

level2_affect ~~ slope1_affect
level2_affect ~~ slope2_affect

slope1_affect ~~ slope2_affect

# constrain means of indicators to zero across time

affect.1 ~ 0
affect.2 ~ 0
affect.3 ~ 0
affect.4 ~ 0
affect.5 ~ 0
affect.6 ~ 0
affect.7 ~ 0
affect.8 ~ 0
affect.9 ~ 0
affect.10 ~ 0

# constrain residual variance to equality across time

affect.1 ~~ res_var*affect.1
affect.2 ~~ res_var*affect.2
affect.3 ~~ res_var*affect.3
affect.4 ~~ res_var*affect.4
affect.5 ~~ res_var*affect.5
affect.6 ~~ res_var*affect.6
affect.7 ~~ res_var*affect.7
affect.8 ~~ res_var*affect.8
affect.9 ~~ res_var*affect.9
affect.10 ~~ res_var*affect.10

&#39;

spline_model_b &lt;- growth(spline_string_b, data = df_wide_b)
summary(spline_model_b, fit.measures = T)</code></pre>
<pre><code>## lavaan 0.6-6 ended normally after 72 iterations
## 
##   Estimator                                         ML
##   Optimization method                           NLMINB
##   Number of free parameters                         24
##   Number of equality constraints                     9
##                                                       
##   Number of observations                           400
##                                                       
## Model Test User Model:
##                                                       
##   Test statistic                                62.857
##   Degrees of freedom                                50
##   P-value (Chi-square)                           0.105
## 
## Model Test Baseline Model:
## 
##   Test statistic                              1520.301
##   Degrees of freedom                                45
##   P-value                                        0.000
## 
## User Model versus Baseline Model:
## 
##   Comparative Fit Index (CFI)                    0.991
##   Tucker-Lewis Index (TLI)                       0.992
## 
## Loglikelihood and Information Criteria:
## 
##   Loglikelihood user model (H0)              -6125.818
##   Loglikelihood unrestricted model (H1)      -6094.389
##                                                       
##   Akaike (AIC)                               12281.635
##   Bayesian (BIC)                             12341.507
##   Sample-size adjusted Bayesian (BIC)        12293.911
## 
## Root Mean Square Error of Approximation:
## 
##   RMSEA                                          0.025
##   90 Percent confidence interval - lower         0.000
##   90 Percent confidence interval - upper         0.043
##   P-value RMSEA &lt;= 0.05                          0.992
## 
## Standardized Root Mean Square Residual:
## 
##   SRMR                                           0.035
## 
## Parameter Estimates:
## 
##   Standard errors                             Standard
##   Information                                 Expected
##   Information saturated (h1) model          Structured
## 
## Latent Variables:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   level1_affect =~                                    
##     affect.1          1.000                           
##     affect.2          1.000                           
##     affect.3          1.000                           
##     affect.4          1.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         0.000                           
##   level2_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          1.000                           
##     affect.6          1.000                           
##     affect.7          1.000                           
##     affect.8          1.000                           
##     affect.9          1.000                           
##     affect.10         1.000                           
##   slope1_affect =~                                    
##     affect.1          1.000                           
##     affect.2          2.000                           
##     affect.3          3.000                           
##     affect.4          4.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         0.000                           
##   slope2_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          5.000                           
##     affect.6          6.000                           
##     affect.7          7.000                           
##     affect.8          8.000                           
##     affect.9          9.000                           
##     affect.10        10.000                           
## 
## Covariances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   level1_affect ~~                                    
##     level2_affect     0.771    0.171    4.511    0.000
##     slope1_affect    -0.030    0.047   -0.632    0.528
##     slope2_affect     0.013    0.019    0.701    0.484
##   level2_affect ~~                                    
##     slope1_affect     0.044    0.047    0.936    0.349
##     slope2_affect    -0.014    0.036   -0.397    0.691
##   slope1_affect ~~                                    
##     slope2_affect    -0.009    0.005   -1.671    0.095
## 
## Intercepts:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##    .affect.1          0.000                           
##    .affect.2          0.000                           
##    .affect.3          0.000                           
##    .affect.4          0.000                           
##    .affect.5          0.000                           
##    .affect.6          0.000                           
##    .affect.7          0.000                           
##    .affect.8          0.000                           
##    .affect.9          0.000                           
##    .affect.10         0.000                           
##     level1_affect     3.971    0.079   50.232    0.000
##     level2_affect     3.868    0.105   36.736    0.000
##     slope1_affect     0.804    0.023   35.669    0.000
##     slope2_affect    -0.781    0.012  -65.077    0.000
## 
## Variances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##     lvl1_ff           0.979    0.182    5.373    0.000
##     lvl2_ff           1.006    0.329    3.060    0.002
##     slp1_ff           0.000    0.016    0.013    0.990
##     slp2_ff          -0.000    0.004   -0.082    0.935
##    .affct.1 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.2 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.3 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.4 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.5 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.6 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.7 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.8 (rs_v)    1.014    0.029   34.641    0.000
##    .affct.9 (rs_v)    1.014    0.029   34.641    0.000
##    .affc.10 (rs_v)    1.014    0.029   34.641    0.000</code></pre>
<p>Notice that the string syntax is the exact same because the process changes at the same point in time, it does not matter if the process changes to ‘more positive’ or ‘more negative.’</p>
</div>
<div id="negative-growth-growth-and-negative-growth" class="section level1">
<h1>3) Negative Growth, Growth, and Negative Growth</h1>
<p>Now a process that goes down, goes up, and then goes back down. The data generating process:</p>
<p><span class="math display">\[\begin{equation}
y_{it} = 
  \begin{cases}
  4 - 0.5t + error_{t}, &amp; \text{if time &lt; 5}\\
  4 + 0.5t + error_{t}, &amp; \text{if 5 &lt; time &lt; 10}\\
  4 - 0.5t + error_{t}, &amp; \text{otherwise}
  \end{cases}
\end{equation}\]</span></p>
<p>The data generating code and plot</p>
<pre class="r"><code>library(tidyverse)
library(lavaan)
library(ggplot2)
library(MASS)

N &lt;- 400
time &lt;- 15

intercept_1 &lt;- 4
intercept_2 &lt;- 4
intercept_3 &lt;- 4

growth1 &lt;- -0.5
growth2 &lt;- 0.5
growth3 &lt;- -0.5


df_matrix_c &lt;- matrix(, ncol = 3, nrow = N*time)


count &lt;- 0

for(i in 1:N){
  
  unob_het_y &lt;- rnorm(1,0,1)
  
  
  for(j in 1:time){
    
    count &lt;- count + 1
    
    if(j &lt; 5){
      df_matrix_c[count, 1] &lt;- i
      df_matrix_c[count, 2] &lt;- j
      df_matrix_c[count, 3] &lt;- intercept_1 + growth1*j + unob_het_y + rnorm(1,0,1)
      
    }else if(j &gt;= 5 &amp;&amp; j &lt; 10){
      
      df_matrix_c[count, 1] &lt;- i
      df_matrix_c[count, 2] &lt;- j
      df_matrix_c[count, 3] &lt;- intercept_2 + growth2*j + unob_het_y + rnorm(1,0,1)
      
      
    }else{
      
      df_matrix_c[count, 1] &lt;- i
      df_matrix_c[count, 2] &lt;- j
      df_matrix_c[count, 3] &lt;- intercept_3 + growth3*j + unob_het_y + rnorm(1,0,1)
      
    }
  }
  
}

df_c &lt;- data.frame(df_matrix_c)

names(df_c) &lt;- c(&#39;id&#39;, &#39;time&#39;, &#39;affect&#39;)

df1_c &lt;- df_c %&gt;%
  filter(time &lt; 5)

df2_c &lt;- df_c %&gt;%
  filter(time &gt;= 5 &amp; time &lt; 10)

df3_c &lt;- df_c %&gt;%
  filter(time &gt;= 10)

df_sum1_c &lt;- df1_c %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

df_sum2_c &lt;- df2_c %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

df_sum3_c &lt;- df3_c %&gt;%
  group_by(time) %&gt;%
  summarise(
    affect = mean(affect)
  )

ggplot() + 
  geom_point(data = df1_c, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df1_c, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_point(data = df2_c, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df2_c, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df_sum1_c, aes(x = time, y = affect)) + 
  geom_line(data = df_sum2_c, aes(x = time, y = affect)) + 
  geom_point(data = df3_c, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df3_c, aes(x = time, y = affect, group = id), color = &#39;gray85&#39;) + 
  geom_line(data = df_sum3_c, aes(x = time, y = affect)) + 
  theme_wsj()</code></pre>
<p><img src="/Computational_Notes/spline_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Now estimate the parameters using SEM:</p>
<pre class="r"><code>library(lavaan)

df_wide_c &lt;- reshape(df_c, idvar = &#39;id&#39;, timevar = &#39;time&#39;, direction = &#39;wide&#39;)


spline_string_c &lt;- &#39;

# latent intercept for first third

level1_affect =~ 1*affect.1 + 1*affect.2 + 1*affect.3 + 1*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + 0*affect.13 + 0*affect.14 + 0*affect.15

# latent intercept for second third

level2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 1*affect.5 + 1*affect.6 + 1*affect.7 + 1*affect.8 + 1*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + 0*affect.13 + 0*affect.14 + 0*affect.15

# latent intercept for final third

level3_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 1*affect.10 + 1*affect.11 + 1*affect.12 + 1*affect.13 + 1*affect.14 + 1*affect.15


# latent slope for first third basis coefficients

slope1_affect =~ 1*affect.1 + 2*affect.2 + 3*affect.3 + 4*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + 0*affect.13 + 0*affect.14 + 0*affect.15

# latent slope for second third basis coefficients

slope2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 5*affect.5 + 6*affect.6 + 7*affect.7 + 8*affect.8 + 9*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + 0*affect.13 + 0*affect.14 + 0*affect.15

# latent slope for final third basis coefficients

slope3_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 0*affect.9 + 10*affect.10 + 11*affect.11 + 12*affect.12 + 13*affect.13 + 14*affect.14 + 15*affect.15



# means and variance of latent factors

level1_affect ~~ level1_affect
level2_affect ~~ level2_affect
level3_affect ~~ level3_affect
slope1_affect ~~ slope1_affect
slope2_affect ~~ slope2_affect
slope3_affect ~~ slope3_affect

# covariance between latent factors

level1_affect ~~ level2_affect
level1_affect ~~ level3_affect
level1_affect ~~ slope1_affect
level1_affect ~~ slope2_affect
level1_affect ~~ slope3_affect

level2_affect ~~ level3_affect
level2_affect ~~ slope1_affect
level2_affect ~~ slope2_affect
level2_affect ~~ slope3_affect

level3_affect ~~ slope1_affect
level3_affect ~~ slope2_affect
level3_affect ~~ slope3_affect

slope1_affect ~~ slope2_affect
slope1_affect ~~ slope3_affect

slope2_affect ~~ slope3_affect

# constrain means of indicators to zero across time

affect.1 ~ 0
affect.2 ~ 0
affect.3 ~ 0
affect.4 ~ 0
affect.5 ~ 0
affect.6 ~ 0
affect.7 ~ 0
affect.8 ~ 0
affect.9 ~ 0
affect.10 ~ 0

# constrain residual variance to equality across time

affect.1 ~~ res_var*affect.1
affect.2 ~~ res_var*affect.2
affect.3 ~~ res_var*affect.3
affect.4 ~~ res_var*affect.4
affect.5 ~~ res_var*affect.5
affect.6 ~~ res_var*affect.6
affect.7 ~~ res_var*affect.7
affect.8 ~~ res_var*affect.8
affect.9 ~~ res_var*affect.9
affect.10 ~~ res_var*affect.10

&#39;

spline_model_c &lt;- growth(spline_string_c, data = df_wide_c)
summary(spline_model_c, fit.measures = T)</code></pre>
<pre><code>## lavaan 0.6-6 ended normally after 140 iterations
## 
##   Estimator                                         ML
##   Optimization method                           NLMINB
##   Number of free parameters                         42
##   Number of equality constraints                     9
##                                                       
##   Number of observations                           400
##                                                       
## Model Test User Model:
##                                                       
##   Test statistic                                92.306
##   Degrees of freedom                               102
##   P-value (Chi-square)                           0.744
## 
## Model Test Baseline Model:
## 
##   Test statistic                              3122.724
##   Degrees of freedom                               105
##   P-value                                        0.000
## 
## User Model versus Baseline Model:
## 
##   Comparative Fit Index (CFI)                    1.000
##   Tucker-Lewis Index (TLI)                       1.003
## 
## Loglikelihood and Information Criteria:
## 
##   Loglikelihood user model (H0)              -9072.897
##   Loglikelihood unrestricted model (H1)      -9026.744
##                                                       
##   Akaike (AIC)                               18211.794
##   Bayesian (BIC)                             18343.512
##   Sample-size adjusted Bayesian (BIC)        18238.801
## 
## Root Mean Square Error of Approximation:
## 
##   RMSEA                                          0.000
##   90 Percent confidence interval - lower         0.000
##   90 Percent confidence interval - upper         0.020
##   P-value RMSEA &lt;= 0.05                          1.000
## 
## Standardized Root Mean Square Residual:
## 
##   SRMR                                           0.037
## 
## Parameter Estimates:
## 
##   Standard errors                             Standard
##   Information                                 Expected
##   Information saturated (h1) model          Structured
## 
## Latent Variables:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   level1_affect =~                                    
##     affect.1          1.000                           
##     affect.2          1.000                           
##     affect.3          1.000                           
##     affect.4          1.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         0.000                           
##     affect.11         0.000                           
##     affect.12         0.000                           
##     affect.13         0.000                           
##     affect.14         0.000                           
##     affect.15         0.000                           
##   level2_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          1.000                           
##     affect.6          1.000                           
##     affect.7          1.000                           
##     affect.8          1.000                           
##     affect.9          1.000                           
##     affect.10         0.000                           
##     affect.11         0.000                           
##     affect.12         0.000                           
##     affect.13         0.000                           
##     affect.14         0.000                           
##     affect.15         0.000                           
##   level3_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         1.000                           
##     affect.11         1.000                           
##     affect.12         1.000                           
##     affect.13         1.000                           
##     affect.14         1.000                           
##     affect.15         1.000                           
##   slope1_affect =~                                    
##     affect.1          1.000                           
##     affect.2          2.000                           
##     affect.3          3.000                           
##     affect.4          4.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10         0.000                           
##     affect.11         0.000                           
##     affect.12         0.000                           
##     affect.13         0.000                           
##     affect.14         0.000                           
##     affect.15         0.000                           
##   slope2_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          5.000                           
##     affect.6          6.000                           
##     affect.7          7.000                           
##     affect.8          8.000                           
##     affect.9          9.000                           
##     affect.10         0.000                           
##     affect.11         0.000                           
##     affect.12         0.000                           
##     affect.13         0.000                           
##     affect.14         0.000                           
##     affect.15         0.000                           
##   slope3_affect =~                                    
##     affect.1          0.000                           
##     affect.2          0.000                           
##     affect.3          0.000                           
##     affect.4          0.000                           
##     affect.5          0.000                           
##     affect.6          0.000                           
##     affect.7          0.000                           
##     affect.8          0.000                           
##     affect.9          0.000                           
##     affect.10        10.000                           
##     affect.11        11.000                           
##     affect.12        12.000                           
##     affect.13        13.000                           
##     affect.14        14.000                           
##     affect.15        15.000                           
## 
## Covariances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##   level1_affect ~~                                    
##     level2_affect     1.323    0.206    6.420    0.000
##     level3_affect     1.314    0.273    4.809    0.000
##     slope1_affect     0.014    0.044    0.323    0.747
##     slope2_affect    -0.046    0.025   -1.814    0.070
##     slope3_affect    -0.024    0.020   -1.185    0.236
##   level2_affect ~~                                    
##     level3_affect     1.114    0.425    2.619    0.009
##     slope1_affect    -0.140    0.054   -2.574    0.010
##     slope2_affect    -0.042    0.058   -0.719    0.472
##     slope3_affect    -0.006    0.032   -0.195    0.846
##   level3_affect ~~                                    
##     slope1_affect    -0.148    0.074   -2.014    0.044
##     slope2_affect    -0.014    0.055   -0.252    0.801
##     slope3_affect    -0.116    0.065   -1.778    0.075
##   slope1_affect ~~                                    
##     slope2_affect     0.019    0.007    2.742    0.006
##     slope3_affect     0.011    0.006    2.059    0.039
##   slope2_affect ~~                                    
##     slope3_affect     0.001    0.004    0.140    0.889
## 
## Intercepts:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##    .affect.1          0.000                           
##    .affect.2          0.000                           
##    .affect.3          0.000                           
##    .affect.4          0.000                           
##    .affect.5          0.000                           
##    .affect.6          0.000                           
##    .affect.7          0.000                           
##    .affect.8          0.000                           
##    .affect.9          0.000                           
##    .affect.10         0.000                           
##    .affect.11         0.000                           
##    .affect.12         0.000                           
##    .affect.13         0.000                           
##    .affect.14         0.000                           
##    .affect.15         0.000                           
##     level1_affect     3.846    0.078   49.098    0.000
##     level2_affect     4.085    0.125   32.789    0.000
##     level3_affect     3.730    0.169   22.038    0.000
##     slope1_affect    -0.471    0.022  -21.810    0.000
##     slope2_affect     0.484    0.016   30.033    0.000
##     slope3_affect    -0.482    0.013  -37.602    0.000
## 
## Variances:
##                    Estimate  Std.Err  z-value  P(&gt;|z|)
##     lvl1_ff           0.993    0.179    5.545    0.000
##     lvl2_ff           1.237    0.463    2.669    0.008
##     lvl3_ff           2.472    0.867    2.853    0.004
##     slp1_ff          -0.008    0.014   -0.555    0.579
##     slp2_ff           0.007    0.008    0.833    0.405
##     slp3_ff           0.009    0.005    1.761    0.078
##    .affct.1 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.2 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.3 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.4 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.5 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.6 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.7 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.8 (rs_v)    0.975    0.029   33.458    0.000
##    .affct.9 (rs_v)    0.975    0.029   33.458    0.000
##    .affc.10 (rs_v)    0.975    0.029   33.458    0.000
##    .affc.11           1.010    0.080   12.650    0.000
##    .affc.12           1.023    0.078   13.168    0.000
##    .affc.13           1.098    0.083   13.272    0.000
##    .affc.14           1.038    0.082   12.722    0.000
##    .affc.15           0.976    0.088   11.040    0.000</code></pre>
<p>Again, the basis coefficients are the important piece here:</p>
<pre class="r"><code>&#39;


# latent slope for first third basis coefficients

slope1_affect =~ 1*affect.1 + 2*affect.2 + 3*affect.3 + 4*affect.4 + 
                 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 
                 0*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + 
                 0*affect.13 + 0*affect.14 + 0*affect.15

# latent slope for second third basis coefficients

slope2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + 
                 5*affect.5 + 6*affect.6 + 7*affect.7 + 8*affect.8 + 
                 9*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + 
                 0*affect.13 + 0*affect.14 + 0*affect.15

# latent slope for final third basis coefficients

slope3_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 +
                 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + 
                 0*affect.9 + 10*affect.10 + 11*affect.11 + 12*affect.12 + 
                 13*affect.13 + 14*affect.14 + 15*affect.15



&#39;</code></pre>
<pre><code>## [1] &quot;\n\n\n# latent slope for first third basis coefficients\n\nslope1_affect =~ 1*affect.1 + 2*affect.2 + 3*affect.3 + 4*affect.4 + \n                 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + \n                 0*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + \n                 0*affect.13 + 0*affect.14 + 0*affect.15\n\n# latent slope for second third basis coefficients\n\nslope2_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 + \n                 5*affect.5 + 6*affect.6 + 7*affect.7 + 8*affect.8 + \n                 9*affect.9 + 0*affect.10 + 0*affect.11 + 0*affect.12 + \n                 0*affect.13 + 0*affect.14 + 0*affect.15\n\n# latent slope for final third basis coefficients\n\nslope3_affect =~ 0*affect.1 + 0*affect.2 + 0*affect.3 + 0*affect.4 +\n                 0*affect.5 + 0*affect.6 + 0*affect.7 + 0*affect.8 + \n                 0*affect.9 + 10*affect.10 + 11*affect.11 + 12*affect.12 + \n                 13*affect.13 + 14*affect.14 + 15*affect.15\n\n\n\n&quot;</code></pre>
<p>Bo<span class="math inline">\(^2\)</span>m =)</p>
</div>
